name: Update Warframe Hashes Monthly

on:
  schedule:
    - cron: "0 0 1 * *"   # Run monthly on the 1st at 00:00 UTC
  workflow_dispatch:       # <-- Allows manual "Run workflow" button

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install LZMA tools
        run: sudo apt-get update && sudo apt-get install -y xz-utils

      - name: Download EN hash list (.lzma)
        run: |
          curl -L -o index_en.txt.lzma "https://origin.warframe.com/PublicExport/index_en.txt.lzma"

      - name: Decompress hash list into text
        run: |
          xz --decompress --stdout index_en.txt.lzma > index_en.txt

      - name: Update TypeScript DATA_HASHES.ts
        run: |
          node << 'EOF'
          const fs = require('fs');

          const lines = fs.readFileSync('index_en.txt', 'utf8').trim().split('\n');
          const hashMap = {};

          for (const line of lines) {
            const [file, hash] = line.split('!00_');
            hashMap[file] = `!00_${hash}`;
          }

          const targetPath = 'src/app/constants/DATA_HASHES.ts';
          let content = fs.readFileSync(targetPath, 'utf8');

          for (const file in hashMap) {
            const escaped = file.replace(/\./g, '\\.');
            const regex = new RegExp(`${escaped}!00_[A-Za-z0-9+\/=\\-]+`, 'g');
            content = content.replace(regex, `${file}${hashMap[file]}`);
          }

          fs.writeFileSync(targetPath, content);
          console.log("Updated hashes:", hashMap);
          EOF

      - name: Commit & push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Monthly: Update DATA_HASHES.ts with latest Warframe hashes" || echo "No changes to commit"
          git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
